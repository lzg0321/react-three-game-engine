"use strict";Object.defineProperty(exports,"__esModule",{value:!0});var e,t=require("react"),n=(e=t)&&"object"==typeof e&&"default"in e?e.default:e,r=require("planck-js");function i(){return(i=Object.assign||function(e){for(var t=1;t<arguments.length;t++){var n=arguments[t];for(var r in n)Object.prototype.hasOwnProperty.call(n,r)&&(e[r]=n[r])}return e}).apply(this,arguments)}function o(e,t){if(null==e)return{};var n,r,i={},o=Object.keys(e);for(r=0;r<o.length;r++)t.indexOf(n=o[r])>=0||(i[n]=e[n]);return i}require("planck-js/lib");var u,a,c=t.createContext(null),s=function(){return t.useContext(c).world},f=function(){return t.useContext(c)},l=function(e){var n=t.useRef(0),r=t.useRef({}),i=t.useCallback((function(e){var t=n.current;return n.current+=1,r.current[t]=e,function(){delete r.current[t]}}),[r]);return t.useEffect((function(){if(e){var t=e.onmessage;e.onmessage=function(e){Object.values(r.current).forEach((function(t){t(e)})),t&&t(e)}}}),[e,r]),i};!function(e){e[e.INIT=0]="INIT",e[e.STEP=1]="STEP",e[e.LOGIC_FRAME=2]="LOGIC_FRAME",e[e.ADD_BODY=3]="ADD_BODY",e[e.REMOVE_BODY=4]="REMOVE_BODY",e[e.SET_BODY=5]="SET_BODY",e[e.UPDATE_BODY=6]="UPDATE_BODY",e[e.PHYSICS_STEP_PROCESSED=7]="PHYSICS_STEP_PROCESSED",e[e.READY_FOR_PHYSICS=8]="READY_FOR_PHYSICS"}(u||(u={})),function(e){e[e.FRAME=0]="FRAME",e[e.PHYSICS_STEP=1]="PHYSICS_STEP",e[e.SYNC_BODIES=2]="SYNC_BODIES",e[e.BEGIN_COLLISION=3]="BEGIN_COLLISION",e[e.END_COLLISION=4]="END_COLLISION",e[e.MESSAGE=5]="MESSAGE",e[e.INITIATED=6]="INITIATED"}(a||(a={}));var d,v,g=function(e){return e.getUserData()||null},S=function(e){return e&&e.uuid?e.uuid:""},p=function(e){return e?e.fixtureIndex:-1};!function(e){e.static="static",e.kinematic="kinematic",e.dynamic="dynamic"}(d||(d={})),function(e){e.box="box",e.circle="circle"}(v||(v={}));var b=t.createContext(null),E=function(){return t.useContext(b)},y=function(e){var r=e.children,i=t.useState((function(){return new Map}))[0],o=t.useState((function(){return new Set}))[0],u=t.useState((function(){return new Set}))[0],a=t.useState(!1),c=a[0],s=a[1],f=t.useRef(!1),l=t.useRef(!1);return n.createElement(b.Provider,{value:{bodies:i,dynamicBodies:o,collisionListeners:u,bodiesNeedSync:c,setBodiesNeedSync:s,bodiesNeedSyncRef:f,logicBodiesNeedSyncRef:l}},r)},C=r.Vec2(0,0),x=function(){var e,n,a,c,l=E().bodies,g=t.useState((function(){return new Map}))[0],S=function(e,n){var u=E(),a=u.dynamicBodies,c=u.collisionListeners,f=u.bodiesNeedSyncRef,l=u.logicBodiesNeedSyncRef,g=t.useCallback((function(e){a.add(e),f.current=!0,l.current=!0}),[a,f,l]),S=t.useCallback((function(e){c.add(e)}),[c]),p=s(),b=t.useCallback((function(e){var t=n.get(e);if(t&&t.length>0){var r=t.pop();if(r)return r}return null}),[n]);return t.useCallback((function(t){var n=t.uuid,u=t.cacheKey,a=t.listenForCollisions,c=t.fixtures,s=void 0===c?[]:c,f=t.attachToRope,l=void 0!==f&&f,E=o(t,["uuid","cacheKey","listenForCollisions","fixtures","attachToRope"]),y=e.get(n);if(y)return y;a&&S(n);var C=i({type:d.static,fixedRotation:!0},E),x=C.type,I=null;if(u){var O=b(u);O&&(I=function(e,t){var n=t.uuid,r=t.fixtures,u=void 0===r?[]:r,a=o(t,["uuid","cacheKey","listenForCollisions","fixtures","attachToRope"]);if(u&&u.length>0){var c=e.getFixtureList();u.forEach((function(e,t){var r,o=e.fixtureOptions;o=i({userData:i({uuid:n,fixtureIndex:t},null==(r=o)?void 0:r.userData)},o),c&&(o&&c.setUserData(o.userData),c=c.getNext())}))}var s=a.position,f=a.angle;return s&&e.setPosition(s),f&&e.setAngle(f),e.setActive(!0),e}(O,t))}if(I||(I=p.createBody(C),s&&s.length>0&&s.forEach((function(e,t){var o,u,a,c=e.shape,s=null!=(o=e.fixtureOptions)?o:{};switch(s=i({},s,{userData:i({uuid:n,fixtureIndex:t},null==(u=s)?void 0:u.userData)}),c){case v.box:var f=e.center,g=e.angle;a=r.Box(e.hx/2,e.hy/2,f?r.Vec2(f[0],f[1]):void 0,g);break;case v.circle:var S=e.radius,b=e.position;a=b?r.Circle(r.Vec2(b[0],b[1]),S):r.Circle(S);break;default:throw new Error("Unhandled body shape "+c)}if(s?I&&I.createFixture(a,s):I&&I.createFixture(a),l){var y=E.position,C={maxLength:.5,localAnchorA:y,localAnchorB:y},x=p.createBody({type:d.static,fixedRotation:!0,position:y,angle:E.angle});if(I){var O=r.DistanceJoint({collideConnected:!1,frequencyHz:5,dampingRatio:.5,length:.15},x,I,null!=y?y:r.Vec2(0,0),null!=y?y:r.Vec2(0,0));p.createJoint(r.RopeJoint(C,x,I,null!=y?y:r.Vec2(0,0))),p.createJoint(O)}}}))),x!==d.static&&g(n),!I)throw new Error("No body");return e.set(n,I),I}),[p,e,b,g,S])}(l,g),p=function(e,n){var r=s(),i=E(),o=i.dynamicBodies,u=i.collisionListeners,a=i.bodiesNeedSyncRef,c=i.logicBodiesNeedSyncRef;return t.useCallback((function(t){var i=t.uuid,s=t.cacheKey;o.has(i)&&(o.delete(i),a.current=!0,c.current=!0),u.delete(i);var f=e.get(i);if(f)if(e.delete(i),s){C.set(-1e3,-1e3),f.setPosition(C),C.set(0,0),f.setLinearVelocity(C),f.setActive(!1);var l=n.get(s);l?l.push(f):n.set(s,[f])}else r.destroyBody(f);else console.warn("Body not found for "+i)}),[r,e,o,u,a,c,n])}(l,g),b=function(e){return t.useCallback((function(t){var n=t.uuid,r=t.method,i=t.methodParams,o=e.get(n);o?o[r].apply(o,i):console.warn("Body not found for "+n,e)}),[e])}(l),y=function(e){return t.useCallback((function(t){var n=t.uuid,r=t.data,i=e.get(n);if(i){var o=r.fixtureUpdate;if(o){var u=i.getFixtureList();if(u){var a=o.groupIndex,c=o.categoryBits,s=o.maskBits;if(void 0!==a||void 0!==c||void 0!==s){var f=u.getFilterGroupIndex(),l=u.getFilterCategoryBits(),d=u.getFilterMaskBits();u.setFilterData({groupIndex:void 0!==a?a:f,categoryBits:void 0!==c?c:l,maskBits:void 0!==s?s:d})}}}}else console.warn("Body not found for "+n)}),[e])}(l),x=t.useCallback((function(e){var t=e.data,n=t.props,r=void 0===n?{}:n;switch(t.type){case u.ADD_BODY:S(r);break;case u.REMOVE_BODY:p(r);break;case u.SET_BODY:b(r);break;case u.UPDATE_BODY:y(r)}}),[S,p,b,y]);return e=x,n=f(),t.useEffect((function(){var t=a(e),n=c(e);return function(){t(),n()}}),[a=n.subscribe,c=n.logicSubscribe,e]),null},I=function(e){return{positions:new Float32Array(2*e),angles:new Float32Array(e)}},O=function(e,n){var r=t.useRef(!0),i=t.useState((function(){return I(e)}))[0];return t.useEffect((function(){if(r.current)r.current=!1;else{var t=I(e),n=t.angles;i.positions=t.positions,i.angles=n}}),[e]),i},B=function(){return function(){var e=s(),n=f(),r=n.updateRate,o=n.subscribe,c=n.logicSubscribe,l=t.useRef(0),d=t.useState(0),v=d[0],g=d[1],S=t.useRef(-1),p=t.useRef(-1),b=t.useState(!1),y=b[0],C=b[1],x=t.useState(!1),O=x[0],B=x[1],D=function(e){var n=f(),r=n.buffers,o=n.logicBuffers,u=n.worker,c=n.logicWorker,s=function(e){var n=t.useRef({failedMainCount:0,failedLogicCount:0,lastPhysicsStep:0}),r=E(),o=r.bodiesNeedSyncRef,u=r.logicBodiesNeedSyncRef,c=r.dynamicBodies,s=f(),l=s.buffers,d=s.logicBuffers,v=s.maxNumberOfDynamicObjects,g=function(){var e=E(),n=e.dynamicBodies,r=e.bodies;return t.useCallback((function(e,t){Array.from(n).forEach((function(n,i){var o=r.get(n);if(o){var u=o.getPosition(),a=o.getAngle();e[2*i+0]=u.x,e[2*i+1]=u.y,t[i]=a}}))}),[])}();return t.useCallback((function(t,r,s){var f=r.positions,S=r.angles;if(0!==f.byteLength&&0!==S.byteLength){s?n.current.failedMainCount=0:n.current.failedLogicCount=0,g(f,S);var p={type:a.PHYSICS_STEP,physicsTick:e.current};s?(p.bodies=Array.from(c),o.current=!1):(p.bodies=Array.from(c),u.current=!1);var b=i({},p,{positions:f,angles:S});t.postMessage(b,[f.buffer,S.buffer])}else{if(console.warn("cant send physics update to",s?"main":"logic"),s){if(n.current.failedMainCount>=2){var E=I(v),y=E.angles;l.positions=E.positions,l.angles=y}}else if(n.current.failedLogicCount>=2){var C=I(v),x=C.angles;d.positions=C.positions,d.angles=x}s?n.current.failedMainCount+=1:n.current.failedLogicCount+=1}}),[o,u,e,g])}(e),l=t.useCallback((function(e){e?s(u,r,!0):c&&s(c,o,!1)}),[u,c,s,r,o]),d=t.useRef(l);return t.useEffect((function(){d.current=l}),[l,d]),t.useCallback((function(e){d.current(e)}),[d])}(l);t.useEffect((function(){y&&S.current<v&&(D(!0),S.current=v,C(!1))}),[v,y]),t.useEffect((function(){O&&p.current<v&&(D(!1),p.current=v,B(!1))}),[v,O]),t.useEffect((function(){var t=setInterval((function(){l.current+=1,g((function(e){return e+1})),e.step(r)}),r);return function(){clearInterval(t)}}),[]);var h=function(e){var n=f(),r=n.buffers,i=n.logicBuffers;return t.useCallback((function(e,t,n,o){var u=e?r:i;u.positions=n,u.angles=o}),[r,i,e,n.worker,n.logicWorker])}(l);t.useEffect((function(){var e=function(e,t){void 0===t&&(t=!0);var n=e.data.type;n===u.READY_FOR_PHYSICS?t?C(!0):B(!0):n===u.PHYSICS_STEP_PROCESSED&&(h(t,e.data.physicsTick,e.data.positions,e.data.angles),t?C(!0):B(!0))},t=o(e),n=c((function(t){return e(t,!1)}));return function(){t(),n()}}),[o,c,h])}(),null},D=function(){var e,n,r,i,o,u=s(),c=(e=f(),n=e.worker,r=e.logicWorker,i=E().collisionListeners,o=t.useCallback((function(e,t,i,o,u){var c={type:a.BEGIN_COLLISION,props:{uuid:e,data:t,fixtureIndex:i,collidedFixtureIndex:o,isSensor:u}};n.postMessage(c),r&&r.postMessage(c)}),[n,r]),t.useCallback((function(e,t){var n=g(e),r=g(t),u=S(n),a=S(r);u&&i.has(u)&&o(u,r,p(n),p(r),t.isSensor()),a&&i.has(a)&&o(a,n,p(r),p(n),e.isSensor())}),[i,o])),l=function(){var e=f(),n=e.worker,r=e.logicWorker,i=E().collisionListeners,o=t.useCallback((function(e,t,i,o,u){var c={type:a.END_COLLISION,props:{uuid:e,data:t,fixtureIndex:i,collidedFixtureIndex:o,isSensor:u}};n.postMessage(c),r&&r.postMessage(c)}),[n,r]);return t.useCallback((function(e,t){var n=g(e),r=g(t),u=S(n),a=S(r);u&&i.has(u)&&o(u,r,p(n),p(r),t.isSensor()),a&&i.has(a)&&o(a,n,p(r),p(n),e.isSensor())}),[i,o])}();return t.useEffect((function(){u.on("begin-contact",(function(e){var t=e.getFixtureA(),n=e.getFixtureB();c(t,n)})),u.on("end-contact",(function(e){var t=e.getFixtureA(),n=e.getFixtureB();l(t,n)}))}),[u]),null};exports.App=function(e){var o=e.worldParams,u=e.worker,s=e.config,f=s.updateRate,d=s.maxNumberOfDynamicObjects,v=i({allowSleep:!0,gravity:r.Vec2(0,0)},o),g=t.useState((function(){return r.World(v)}))[0],S=l(u),p=function(e,n){var r=t.useState(),i=r[0],o=r[1];return t.useEffect((function(){var e,t=n((function(t){t.data.command&&function(t){"connect"!==t.data.command?"forward"!==t.data.command||e.postMessage(t.data.message):o(e=t.ports[0])}(t)}));return function(){t()}}),[e,n,o]),i}(u,S),b=function(e){return l(e)}(p),E=O(d),C=O(p?d:0),I=t.useRef({mainCount:0,logicCount:0});return t.useEffect((function(){u.postMessage({type:a.INITIATED})}),[u]),n.createElement(c.Provider,{value:{world:g,updateRate:f,worker:u,logicWorker:p,subscribe:S,logicSubscribe:b,buffers:E,logicBuffers:C,buffersRef:I,maxNumberOfDynamicObjects:d}},n.createElement(y,null,n.createElement(B,null),n.createElement(x,null),n.createElement(D,null)))};
//# sourceMappingURL=physicsapp.cjs.production.min.js.map
