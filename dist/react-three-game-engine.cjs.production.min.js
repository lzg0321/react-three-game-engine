"use strict";Object.defineProperty(exports,"__esModule",{value:!0}),require("planck-js/lib"),require("planck-js");var e,n,t,r,o,a=require("react"),u=(e=a)&&"object"==typeof e&&"default"in e?e.default:e,i=require("three"),s=require("@react-three/fiber"),c=require("react-nil"),l=require("valtio");function d(){return(d=Object.assign||function(e){for(var n=1;n<arguments.length;n++){var t=arguments[n];for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])}return e}).apply(this,arguments)}!function(e){e[e.INIT=0]="INIT",e[e.STEP=1]="STEP",e[e.LOGIC_FRAME=2]="LOGIC_FRAME",e[e.ADD_BODY=3]="ADD_BODY",e[e.REMOVE_BODY=4]="REMOVE_BODY",e[e.SET_BODY=5]="SET_BODY",e[e.UPDATE_BODY=6]="UPDATE_BODY",e[e.PHYSICS_STEP_PROCESSED=7]="PHYSICS_STEP_PROCESSED",e[e.READY_FOR_PHYSICS=8]="READY_FOR_PHYSICS"}(n||(n={})),function(e){e[e.FRAME=0]="FRAME",e[e.PHYSICS_STEP=1]="PHYSICS_STEP",e[e.SYNC_BODIES=2]="SYNC_BODIES",e[e.BEGIN_COLLISION=3]="BEGIN_COLLISION",e[e.END_COLLISION=4]="END_COLLISION",e[e.MESSAGE=5]="MESSAGE",e[e.INITIATED=6]="INITIATED"}(t||(t={})),(r=exports.BodyType||(exports.BodyType={})).static="static",r.kinematic="kinematic",r.dynamic="dynamic",(o=exports.BodyShape||(exports.BodyShape={})).box="box",o.circle="circle";var p,f,m,v=a.createContext(null),E=function(){return a.useContext(v)},y=function(e){var t=e.children,r=e.worker,o=a.useCallback((function(e){r.postMessage({type:n.ADD_BODY,props:e})}),[]),i=a.useCallback((function(e){r.postMessage({type:n.REMOVE_BODY,props:e})}),[]),s=a.useCallback((function(e){r.postMessage({type:n.SET_BODY,props:e})}),[]),c=a.useCallback((function(e){r.postMessage({type:n.UPDATE_BODY,props:e})}),[]);return u.createElement(v.Provider,{value:{workerAddBody:o,workerRemoveBody:i,workerSetBody:s,workerUpdateBody:c}},t)},h=a.createContext(null),C=function(){return a.useContext(h).data},g=function(e){var n=e.children,t=a.useState({bodies:{}});return u.createElement(h.Provider,{value:{data:t[0]}},n)},x=i.MathUtils.lerp,S=a.createContext(null),k=function(e,n,t,r){void 0===t&&(t=!0),void 0===r&&(r=!0);var o=a.useContext(S).addSubscription;a.useEffect((function(){if(r){var a=o(e,n,t);return function(){a()}}}),[e,n,t,r,o])},O=function(e){var n=e.children,t=a.useRef({}),r=a.useCallback((function(e){Object.values(t.current).forEach((function(n){var r=n.uuid,o=n.target,a=n.applyAngle,u=n.lastUpdate;if(o){var i=n.objectRef.current;if(i){var s=o.position,c=o.angle,l=e(null!=u?u:Date.now());i.position.x=x(i.position.x,s[0],l),i.position.y=x(i.position.y,s[1],l),a&&(i.rotation.z=c),t.current[r].lastUpdate=Date.now()}}}))}),[t]),o=C(),i=a.useCallback((function(e,n,r){Object.entries(t.current).forEach((function(a){var u=a[0],i=a[1],s=i.target,c=i.applyAngle,l=i.objectRef.current;if(l){var d=function(e,n){if(void 0!==n&&e.positions.length){var t=2*n;return{position:e.positions.slice(t,t+2),angle:e.angles[n]}}return null}({positions:e,angles:n},o.bodies[u]);d&&(r?(l.position.x=d.position[0],l.position.y=d.position[1],c&&(l.rotation.x=d.angle)):s&&(l.position.x=s.position[0],l.position.y=s.position[1],c&&(l.rotation.x=s.angle)),t.current[u].target={position:d.position,angle:d.angle})}}))}),[t,o]),s=a.useCallback((function(e,n,r){return t.current[e]={uuid:e,objectRef:n,applyAngle:r},function(){delete t.current[e]}}),[t]);return u.createElement(S.Provider,{value:{lerpMeshes:r,updateMeshes:i,addSubscription:s}},n)},b=function(e){var n=E(),t=n.workerSetBody,r=n.workerUpdateBody;return a.useMemo((function(){return{applyForceToCenter:function(n,r){t({uuid:null!=r?r:e,method:"applyForceToCenter",methodParams:[n,!0]})},applyLinearImpulse:function(n,r,o){t({uuid:null!=o?o:e,method:"applyLinearImpulse",methodParams:[n,r,!0]})},setPosition:function(n,r){t({uuid:null!=r?r:e,method:"setPosition",methodParams:[n]})},setAwake:function(n,r){t({uuid:null!=r?r:e,method:"setAwake",methodParams:[n]})},setLinearVelocity:function(n,r){t({uuid:null!=r?r:e,method:"setLinearVelocity",methodParams:[n]})},updateBody:function(n,t){r({uuid:null!=t?t:e,data:n})},setAngle:function(n,r){t({uuid:null!=r?r:e,method:"setAngle",methodParams:[n]})}}}),[e])},M=function(e,n){void 0===n&&(n={});var t=n.applyAngle,r=void 0!==t&&t,o=n.cacheKey,u=n.uuid,s=n.fwdRef,c=n.listenForCollisions,l=void 0!==c&&c,p=n.syncBody,f=void 0===p||p,m=a.useRef(null),v=s||m,y=a.useState((function(){return u||(v.current||(v.current=new i.Object3D),v.current.uuid)}))[0],h=a.useState((function(){return e().type!==exports.BodyType.static}))[0],C=E(),g=C.workerAddBody,x=C.workerRemoveBody;a.useLayoutEffect((function(){var n=e();v.current||(v.current=new i.Object3D);var t,r,a=v.current;return a&&(a.position.x=(null==(t=n.position)?void 0:t.x)||0,a.position.y=(null==(r=n.position)?void 0:r.y)||0),g(d({uuid:y,listenForCollisions:l,cacheKey:o},n)),function(){x({uuid:y,cacheKey:o})}}),[]),k(y,v,r,f&&h);var S=b(y);return[v,S,y]},T=a.createContext(null),w=function(){return a.useContext(T).subscribe},P=function(e){return u.createElement(T.Provider,{value:{subscribe:e.subscribe}},e.children)},I=a.createContext(null),N=function(e){var r=e.children,o=e.worker,i=e.noLerping,s=void 0!==i&&i,c=a.useRef(Date.now()),l=a.useRef(0),p=a.useRef({}),f=a.useContext(S).updateMeshes,m=a.useCallback((function(e){var n=c.current+1e3/30+1,t=(Date.now()-e)/(n-e);return(t=t>1?1:t)<0?0:t}),[c]),v=a.useCallback((function(e){var n=l.current;return l.current+=1,p.current[n]=e,function(){delete p.current[n]}}),[p]),E=w(),y=C(),h=a.useRef({timer:null,hasReceived:!1});return a.useEffect((function(){h.current.timer=setTimeout((function(){console.warn("no initial physics data received...")}),1e3);var e=E((function(e){var r,a,u;if(e.data.type===t.PHYSICS_STEP){h.current.hasReceived=!0,h.current.timer&&clearInterval(h.current.timer),h.current.timer=setTimeout((function(){console.warn("over 1 second since last physics step...")}),1e3);var i=e.data.positions,l=e.data.angles;f(i,l,s),o.postMessage({type:n.PHYSICS_STEP_PROCESSED,positions:i,angles:l,physicsTick:e.data.physicsTick},[i.buffer,l.buffer]),e.data.bodies&&(y.bodies=e.data.bodies.reduce((function(n,t){var r;return d({},n,((r={})[t]=e.data.bodies.indexOf(t),r))}),{})),r=c.current,a=Date.now(),u=r?(a-r)/1e3:1/60,c.current=a,Object.values(p.current).forEach((function(e){e(u)}))}}));return o.postMessage({type:n.READY_FOR_PHYSICS}),function(){e()}}),[E,p,c,o,f,s,y]),u.createElement(I.Provider,{value:{onFixedUpdate:v,getPhysicsStepTimeRemainingRatio:m}},r)},D=function(e){var n=a.useRef(0),t=a.useRef({}),r=a.useCallback((function(e){var r=n.current;return n.current+=1,t.current[r]=e,function(){delete t.current[r]}}),[t]);return a.useEffect((function(){if(e){var n=e.onmessage;e.onmessage=function(e){Object.values(t.current).forEach((function(n){n(e)})),n&&n(e)}}}),[e,t]),r},R=a.createContext(null),_=function(e){var r=e.children,o=e.config,i=e.worldParams,s=e.physicsWorker,c=a.useState(!1),l=c[0],d=c[1];a.useEffect((function(){s.postMessage({type:n.INIT,props:{config:o,worldParams:i}})}),[s]);var p=D(s);return a.useEffect((function(){var e=p((function(n){return n.data.type===t.INITIATED&&d(!0),function(){e()}}))}),[p,d]),l?u.createElement(R.Provider,{value:{worker:s}},u.createElement(y,{worker:s},u.createElement(g,null,u.createElement(O,null,u.createElement(P,{subscribe:p},u.createElement(N,{worker:s},r)))))):null},A=function(e){var n=e.children,t=a.useContext(I).getPhysicsStepTimeRemainingRatio,r=a.useContext(S).lerpMeshes,o=a.useCallback((function(){r(t)}),[t,r]);return s.useFrame(o),u.createElement(u.Fragment,null,n)},B=a.createContext(null),Y=function(e){var n=e.children,r=a.useState({})[0],o=a.useState({})[0],i=a.useCallback((function(e,n,t){e?r[n]=t:o[n]=t}),[]),s=a.useCallback((function(e,n){e?delete r[n]:delete o[n]}),[]),c=a.useCallback((function(e){r[e.uuid]&&r[e.uuid](e.data,e.fixtureIndex,e.collidedFixtureIndex,e.isSensor)}),[r]),l=a.useCallback((function(e){o[e.uuid]&&o[e.uuid](e.data,e.fixtureIndex,e.collidedFixtureIndex,e.isSensor)}),[o]),d=w();return a.useEffect((function(){return d((function(e){switch(e.data.type){case t.BEGIN_COLLISION:c(e.data.props);break;case t.END_COLLISION:l(e.data.props)}}))}),[]),u.createElement(B.Provider,{value:{addCollisionHandler:i,removeCollisionHandler:s,handleBeginCollision:c,handleEndCollision:l}},n)},U=a.createContext(null),L=function(e){var n=e.children,t=a.useState({}),r=t[0],o=t[1],i=a.useCallback((function(e,n){return o((function(t){var r;return d({},t,((r={})[e]=n,r))})),function(){o((function(n){var t=d({},n);return delete t[e],t}))}}),[o]);return u.createElement(U.Provider,{value:{meshes:r,addMesh:i}},n)},F=a.createContext(null),j=function(){return a.useContext(F)},W=function(){return j().subscribeToMessage},H=function(e){var n=e.children,t=a.useRef(0),r=a.useState({})[0],o=a.useCallback((function(e,n){var o,a=t.current;return t.current+=1,r[e]?r[e][a]=n:r[e]=((o={})[a]=n,o),function(){delete r[e][a]}}),[r]),i=a.useCallback((function(e){var n=e.data,t=r[e.key];t&&Object.values(t).forEach((function(e){e(n)}))}),[r]);return u.createElement(F.Provider,{value:{handleMessage:i,subscribeToMessage:o}},n)};!function(e){e.SYNC_COMPONENT="SYNC_COMPONENT"}(p||(p={})),function(e){e[e.MOUNT=0]="MOUNT",e[e.UNMOUNT=1]="UNMOUNT",e[e.UPDATE=2]="UPDATE"}(f||(f={})),function(e){e[e.PLAYER=0]="PLAYER"}(m||(m={}));var G=function(e){var n=e.children,t=e.mappedComponentTypes,r=W(),o=a.useState({}),i=o[0],s=o[1];return a.useEffect((function(){var e=r(p.SYNC_COMPONENT,(function(e){var n=e.info,t=e.data||{};switch(e.messageType){case f.MOUNT:s((function(e){var r;return d({},e,((r={})[n.componentKey]={componentType:n.componentType,props:t},r))}));break;case f.UPDATE:s((function(e){var r,o=e[n.componentKey];return d({},e,((r={})[n.componentKey]={componentType:n.componentType,props:d({},o&&o.props?o.props:{},t)},r))}));break;case f.UNMOUNT:s((function(e){var t=d({},e);return delete t[n.componentKey],t}))}}));return function(){e()}}),[]),u.createElement(u.Fragment,null,n,Object.entries(i).map((function(e){var n=e[1],r=t[n.componentType];return r?u.createElement(r,Object.assign({key:e[0]},n.props)):null})))},q=a.createContext(null),K=function(e){var n=e.children,r=e.worker,o=j().handleMessage,i=a.useCallback((function(e,n){if(e===p.SYNC_COMPONENT)throw new Error(e+" is a reserved message key.");var a={key:e,data:n};r.postMessage({type:t.MESSAGE,message:a}),o(a)}),[r,o]);return u.createElement(q.Provider,{value:{sendMessage:i}},n)},V=function(e){var r=e.children,o=e.worker,i=a.useContext(R).worker,s=j().handleMessage;return a.useEffect((function(){var e=new MessageChannel;i.postMessage({command:"connect"},[e.port1]),o.postMessage({command:"connect"},[e.port2]),o.onmessage=function(e){switch(e.data.type){case t.MESSAGE:s(e.data.message)}},o.postMessage({type:n.INIT})}),[o,i]),u.createElement(u.Fragment,null,r)},z=function(e){var n=e.worker;return u.createElement(H,null,u.createElement(K,{worker:n},u.createElement(V,{worker:n},u.createElement(G,{mappedComponentTypes:e.logicMappedComponents},e.children))))},J=function(e){var n=e.children,t=e.worker;if(!t)return null;var r=D(t);return u.createElement(y,{worker:t},u.createElement(P,{subscribe:r},u.createElement(g,null,u.createElement(O,null,u.createElement(N,{worker:t,noLerping:!0},n)))))},Q=function(e){var n=e.children,r=e.worker,o=j().handleMessage;return a.useEffect((function(){r.onmessage=function(e){switch(e.data.type){case t.MESSAGE:o(e.data.message)}}}),[r]),u.createElement(u.Fragment,null,n)},X=a.createContext(null),Z=function(e){var n=e.worker,t=e.physicsWorker;return u.createElement(X.Provider,{value:{physicsWorker:t,sendMessageToMain:e.sendMessageToMain}},u.createElement(H,null,u.createElement(Q,{worker:n},u.createElement(K,{worker:n},u.createElement(L,null,u.createElement(J,{worker:t},u.createElement(Y,null,e.children)))))))},$=function(){var e=a.useContext(X).sendMessageToMain;return a.useCallback((function(n,t,r){e({key:p.SYNC_COMPONENT,data:{messageType:n,info:t,data:r}})}),[e])};exports.Body=function(e){var n=e.children,t=e.bodyDef,r=e.wrapWithGroup,o=M((function(){return t}),e.params),a=o[0],i=n({ref:a,uuid:o[2],api:o[1]});return r?u.createElement("group",{ref:a},i):i},exports.BodySync=function(e){var n=e.children,t=e.uuid,r=e.bodyRef,o=e.applyAngle,s=void 0===o||o,c=e.isDynamic,l=void 0===c||c,d=e.wrapWithGroup,p=void 0!==d&&d,f=a.useRef(new i.Object3D),m=null!=r?r:f;k(t,m,s,l);var v=b(t),E=n({uuid:t,ref:m,api:null!=v?v:void 0});return p?u.createElement("group",{ref:m},E):E},exports.Engine=function(e){var n=e.children,t=e.logicWorker,r=e.logicMappedComponents;return u.createElement(L,null,u.createElement(_,{physicsWorker:e.physicsWorker,config:e.config,worldParams:e.worldParams},u.createElement(Y,null,u.createElement(A,null,t?u.createElement(z,{worker:t,logicMappedComponents:void 0===r?{}:r},n):n))))},exports.createBoxFixture=function(e){var n=e.width,t=e.height,r=e.center,o=e.angle,a=e.fixtureOptions,u={shape:exports.BodyShape.box,hx:void 0===n?1:n,hy:void 0===t?1:t,fixtureOptions:void 0===a?{}:a};return o&&(u.angle=o),r&&(u.center=r),u},exports.createCircleFixture=function(e){var n=e.radius,t=e.fixtureOptions;return{shape:exports.BodyShape.circle,radius:void 0===n?1:n,position:e.position,fixtureOptions:void 0===t?{}:t}},exports.logicWorkerHandler=function(e,t){var r,o=l.proxy({physicsWorkerLoaded:!1,initiated:!1}),u={physicsWorker:null};e.onmessage=function(e){switch(e.data.command){case"connect":return u.physicsWorker=r=e.ports[0],void(o.physicsWorkerLoaded=!0);case"forward":return void r.postMessage(e.data.message)}switch(e.data.type){case n.INIT:o.initiated=!0}},c.render(a.createElement(require("./logicWorkerApp/index").WorkerApp,{worker:e,state:o,workerRef:u,app:t},null))},exports.physicsWorkerHandler=function(e){e.onmessage=function(t){var r=t.data,o=r.props,u=void 0===o?{}:o;switch(r.type){case n.INIT:var i=u.worldParams,s=void 0===i?{}:i,l=u.config,d=void 0===l?{}:l,p=d.maxNumberOfDynamicObjects,f=void 0===p?100:p,m=d.updateRate,v=void 0===m?1e3/30:m;c.render(a.createElement(require("./worker/app/index").App,{worker:e,config:{maxNumberOfDynamicObjects:f,updateRate:v},worldParams:s},null))}}},exports.useBody=M,exports.useBodyApi=b,exports.useCollisionEvents=function(e,n,t){var r=a.useContext(B),o=r.addCollisionHandler,u=r.removeCollisionHandler;a.useEffect((function(){if(n)return o(!0,e,n),function(){u(!0,e)}}),[e,n]),a.useEffect((function(){if(t)return o(!1,e,t),function(){u(!1,e)}}),[e,t])},exports.useFixedUpdate=function(e){var n=a.useContext(I).onFixedUpdate;a.useEffect((function(){var t=n(e);return function(){t()}}),[n,e])},exports.useOnMessage=W,exports.useSendMessage=function(){return a.useContext(q).sendMessage},exports.useSendSyncComponentMessage=$,exports.useStoreMesh=function(e,n){var t=a.useContext(U).addMesh;a.useEffect((function(){var r=t(e,n);return function(){r()}}),[t,e,n])},exports.useStoredMesh=function(e){var n=a.useContext(U).meshes;return a.useMemo((function(){var t;return null!=(t=n[e])?t:null}),[e,n])},exports.useSubscribeMesh=k,exports.useSyncWithMainComponent=function(e,n,t){var r=$(),o=a.useMemo((function(){return{componentType:e,componentKey:n}}),[e,n]),u=a.useCallback((function(e){r(f.UPDATE,o,e)}),[o]);return a.useEffect((function(){return r(f.MOUNT,o,t),function(){r(f.UNMOUNT,o)}}),[o]),u},exports.withLogicWrapper=function(e){return function(n){return u.createElement(Z,Object.assign({},n),u.createElement(e,null))}};
//# sourceMappingURL=react-three-game-engine.cjs.production.min.js.map
